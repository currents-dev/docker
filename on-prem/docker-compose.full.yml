# Generated by: ./scripts/generate-compose.sh
# Profile: full - All services (redis, mongodb, clickhouse, rustfs)

name: currents_full

# This core Currents application services

# RustFS service configuration
# S3-compatible object storage - usually excluded when using external S3/cloud storage
services:
  # Currents services depend on redis
  director:
    hostname: director
    image: ${DC_IMAGE_REPOSITORY:-currents-}director:${DC_IMAGE_TAG:-dev}
    expose:
      - 1234
    ports:
      - 1234:1234
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - default
    environment:
      - CURRENTS_ENV=onprem
      - API_URL="http://localhost:4000/v1"
      - APP_BASE_URL=http://localhost:4000
      - MONGODB_URI=mongodb://host.docker.internal:27017/?readPreference=primary&directConnection=true&ssl=false
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false
      mongodb:
        condition: service_healthy
        required: false
      redis:
        condition: service_started
        required: false
  api:
    hostname: api
    image: ${DC_IMAGE_REPOSITORY:-currents-}api:${DC_IMAGE_TAG:-dev}
    expose:
      - 4000
    ports:
      - 4000:4000
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
      - INCLUDE_DASHBOARD=onprem
      - MONGODB_URI=mongodb://host.docker.internal:27017/?readPreference=primary&directConnection=true&ssl=false
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_CURRENTS_PASSWORD}
      - AUTOMATED_REPORTS_CURRENTS_DASHBOARD_HOSTNAME=http://host.docker.internal:4000
      - CURRENTS_RECORD_API_URL=http://localhost:1234
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false
      mongodb:
        condition: service_healthy
        required: false
      redis:
        condition: service_started
        required: false
  changestreams-worker:
    image: ${DC_IMAGE_REPOSITORY:-currents-}change-streams:${DC_IMAGE_TAG:-dev}
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
      - MONGODB_URI=mongodb://host.docker.internal:27017/?readPreference=primary&directConnection=true&ssl=false
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_CURRENTS_PASSWORD}
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false
      mongodb:
        condition: service_healthy
        required: false
      redis:
        condition: service_started
        required: false
  write-worker:
    image: ${DC_IMAGE_REPOSITORY:-currents-}writer:${DC_IMAGE_TAG:-dev}
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
      - MONGODB_URI=mongodb://host.docker.internal:27017/?readPreference=primary&directConnection=true&ssl=false
      - AUTOMATED_REPORTS_CURRENTS_DASHBOARD_HOSTNAME=http://host.docker.internal:4000
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_CURRENTS_PASSWORD}
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false
      mongodb:
        condition: service_healthy
        required: false
      redis:
        condition: service_started
        required: false
  scheduler:
    image: ${DC_IMAGE_REPOSITORY:-currents-}scheduler:${DC_IMAGE_TAG:-dev}
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
      - MONGODB_URI=mongodb://host.docker.internal:27017/?readPreference=primary&directConnection=true&ssl=false
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_CURRENTS_PASSWORD}
      - RUN_STARTUP_TASKS=true
    volumes:
      - ${DC_SCHEDULER_STARTUP_VOLUME:-./data/startup}:/app/packages/scheduler/dist/.startup
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false
      mongodb:
        condition: service_healthy
        required: false
      redis:
        condition: service_started
        required: false
  webhooks:
    image: ${DC_IMAGE_REPOSITORY:-currents-}webhooks:${DC_IMAGE_TAG:-dev}
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
      - MONGODB_URI=mongodb://host.docker.internal:27017/?readPreference=primary&directConnection=true&ssl=false
      - DASHBOARD_URL=http://localhost:4000
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false
      mongodb:
        condition: service_healthy
        required: false
      redis:
        condition: service_started
        required: false
  clickhouse:
    hostname: clickhouse
    image: clickhouse/clickhouse-server:25.8
    restart: unless-stopped
    environment:
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: '1'
    healthcheck:
      test:
        - 'CMD-SHELL'
        - 'wget --spider -q clickhouse:8123/ping'
      interval: 2s
      timeout: 5s
      retries: 10
    env_file:
      - .env
    ports:
      - 8123:8123 # HTTP Interface
      - 9123:9000 # TCP Interface
    networks:
      - default
    configs:
      - source: clickhouse_users
        target: /etc/clickhouse-server/users.d/users.xml
    volumes:
      - ${DC_CLICKHOUSE_VOLUME:-./data/clickhouse}:/var/lib/clickhouse
  mongodb:
    hostname: mongodb
    image: mongo:7.0.0
    expose:
      - 27017
    ports:
      - 27017:27017
    restart: unless-stopped
    entrypoint: ['/usr/bin/mongod', '--bind_ip_all', '--replSet', 'rs0']
    networks:
      - default
    healthcheck:
      test:
        - 'CMD-SHELL'
        - (echo "try { rs.status() } catch (err) { rs.initiate({_id:'rs0',members:[{_id:0,host:'mongodb:27017'}]}) }" | mongosh localhost:27017 --quiet) && mongosh --eval 'db.runCommand("ping").ok' localhost:27017 --quiet
      interval: 2s
      timeout: 5s
      retries: 10
    volumes:
      - ${DC_MONGODB_VOLUME:-./data/mongodb}:/data/db
  redis:
    hostname: redis
    image: redis/redis-stack-server:7.4.0-v8
    ports:
      - 6379:6379
    restart: unless-stopped
    networks:
      - default
    volumes:
      - ${DC_REDIS_VOLUME:-./data/redis}:/data
  rustfs:
    hostname: rustfs
    image: rustfs/rustfs:1.0.0-alpha.79
    ports:
      - 9000:9000 # S3 API port
      - 9001:9001 # Web console port
    environment:
      RUSTFS_CONSOLE_ENABLE: "true"
      RUSTFS_ACCESS_KEY: ${RUSTFS_ACCESS_KEY}
      RUSTFS_SECRET_KEY: ${RUSTFS_SECRET_KEY}
    env_file:
      - .env
    networks:
      - default
    volumes:
      - ${DC_RUSTFS_VOLUME:-./data/rustfs}:/data # /data is RustFS's default storage location
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:9000/health || exit 1']
      interval: 2s
      timeout: 5s
      retries: 10
  rustfs-init:
    image: amazon/aws-cli:latest
    depends_on:
      rustfs:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: ${RUSTFS_ACCESS_KEY}
      AWS_SECRET_ACCESS_KEY: ${RUSTFS_SECRET_KEY}
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: >
      sh -c "aws --endpoint-url=http://rustfs:9000 s3 mb s3://currents || true"

    networks:
      - default
networks:
  default: null
configs:
  clickhouse_users:
    content: |
      <?xml version="1.0"?>
      <clickhouse>
          <users>
              <!-- Default user with password from environment (local access only) -->
              <default>
                  <password>${CLICKHOUSE_DEFAULT_PASSWORD}</password>
                  <networks>
                      <ip>::1</ip>
                      <ip>127.0.0.1</ip>
                  </networks>
                  <profile>default</profile>
                  <quota>default</quota>
                  <access_management>1</access_management>
              </default>
              <!-- Currents application user -->
              <currents>
                  <password>${CLICKHOUSE_CURRENTS_PASSWORD}</password>
                  <networks>
                      <ip>::/0</ip>
                  </networks>
                  <profile>default</profile>
                  <quota>default</quota>
              </currents>
          </users>
      </clickhouse>
