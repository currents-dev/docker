# ClickHouse service configuration
# Analytics database for test results and metrics

services:
  clickhouse:
    hostname: clickhouse
    image: clickhouse/clickhouse-server:25.8
    restart: unless-stopped
    environment:
      CLICKHOUSE_SKIP_USER_SETUP: '1'
    healthcheck:
      test:
        - 'CMD-SHELL'
        - 'wget --spider -q clickhouse:8123/ping'
      interval: 2s
      timeout: 5s
      retries: 10
    env_file:
      - .env
    ports:
      - 8123:8123 # HTTP Interface
      - 9123:9000 # TCP Interface
    networks:
      - default
    volumes:
      - clickhousedata:/var/lib/clickhouse

  # Currents services depend on clickhouse
  director:
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false

  api:
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false

  changestreams-worker:
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false

  write-worker:
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false

  scheduler:
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false

  webhooks:
    depends_on:
      clickhouse:
        condition: service_healthy
        required: false

volumes:
  clickhousedata: null
