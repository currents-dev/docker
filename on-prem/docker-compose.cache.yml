# Generated by: ./scripts/generate-compose.sh
# Profile: cache - Cache (redis)

name: currents_cache

# This core Currents application services

# Redis service configuration
# Almost always included - provides caching and pub/sub messaging
services:
  # Currents services depend on redis
  director:
    hostname: director
    image: ${DC_CURRENTS_IMAGE_REPOSITORY:-currents-}director:${DC_CURRENTS_IMAGE_TAG:-dev}
    ports:
      - ${DC_DIRECTOR_PORT:-1234}:1234
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - default
    environment:
      - CURRENTS_ENV=onprem
    depends_on:
      redis:
        condition: service_started
        required: false
  api:
    hostname: api
    image: ${DC_CURRENTS_IMAGE_REPOSITORY:-currents-}api:${DC_CURRENTS_IMAGE_TAG:-dev}
    ports:
      - ${DC_API_PORT:-4000}:4000
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
      - INCLUDE_DASHBOARD=onprem
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_CURRENTS_PASSWORD}
    depends_on:
      redis:
        condition: service_started
        required: false
  changestreams-worker:
    image: ${DC_CURRENTS_IMAGE_REPOSITORY:-currents-}change-streams:${DC_CURRENTS_IMAGE_TAG:-dev}
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_CURRENTS_PASSWORD}
    depends_on:
      redis:
        condition: service_started
        required: false
  write-worker:
    image: ${DC_CURRENTS_IMAGE_REPOSITORY:-currents-}writer:${DC_CURRENTS_IMAGE_TAG:-dev}
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_CURRENTS_PASSWORD}
    depends_on:
      redis:
        condition: service_started
        required: false
  scheduler:
    image: ${DC_CURRENTS_IMAGE_REPOSITORY:-currents-}scheduler:${DC_CURRENTS_IMAGE_TAG:-dev}
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_CURRENTS_PASSWORD}
      - RUN_STARTUP_TASKS=true
    volumes:
      - ${DC_SCHEDULER_STARTUP_VOLUME:-./data/startup}:/app/packages/scheduler/dist/.startup
    depends_on:
      redis:
        condition: service_started
        required: false
  webhooks:
    image: ${DC_CURRENTS_IMAGE_REPOSITORY:-currents-}webhooks:${DC_CURRENTS_IMAGE_TAG:-dev}
    restart: unless-stopped
    networks:
      - default
    env_file:
      - .env
    environment:
      - CURRENTS_ENV=onprem
    depends_on:
      redis:
        condition: service_started
        required: false
  redis:
    hostname: redis
    image: ${DC_REDIS_IMAGE:-redis/redis-stack-server:7.4.0-v8}
    ports:
      - ${DC_REDIS_PORT:-127.0.0.1:6379}:6379
    restart: unless-stopped
    networks:
      - default
    volumes:
      - ${DC_REDIS_VOLUME:-./data/redis}:/data
networks:
  default: null
